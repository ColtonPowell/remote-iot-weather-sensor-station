<!doctype html>
<html>
   <head>
      <meta http-equiv="content-type"  content="text/html; charset=UTF-8">
      <title>COEN243 - Weather Station</title>
      <script src="node_modules/chart.js/dist/Chart.bundle.js"></script>
      <script src="node_modules/chart.js/samples/utils.js"> </script>
      <script src="other_modules/mqttws31.js" type="text/javascript"> </script>
      <script src="js/config.js" > </script> <script src="js/update.js" > </script> <script src="js/index.js" > </script>
      <style>
       canvas{
	   -moz-user-select: none;
	   -webkit-user-select: none;
	   -ms-user-select: none;
       }
      </style>
   </head>

   <body>
      <script>

       /****************************************************************************
	* Variable definitions
	****************************************************************************/
       
       var num_stats		 = 4;    // The # of stats to maintain
       var num_readings		 = 10;   // The number of sensor readings per graph
       var canvases		 = [];   // 0-3 for device 1, 4-7 for device 2, ...
       var divs			 = [];
       var devices		 = [];   // canvas count = devices.length * 4
       var devices_timeouts	 = [];
       var timeout_duration = 10000;
       var key                   = [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16 ];
       var iv                    = [ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ];
       
       // The arrays that hold the data for each statistic
       // Temperature_stats[0] contains an array of temperature data for device 0
       // Temperature_stats[1] contains an array of temperature data for device 1
       // etc....
       var Temperature_stats     = [[]];
       var Light_stats		 = [[]];
       var Humidity_stats	 = [[]];
       var POT_stats		 = [[]];

       // index_strings used for graph x-axes
       var index_strings	 = []; // index_strings[i] = i.toString();
       
       // Initialize index strings for later
       for (var i = num_readings - 1; i >= 0; i--) {
	   index_strings[i] = i.toString();
       }
       
       // For testing locally:
       // var client = new Paho.MQTT.Client("localhost", Number("9001"), "local-web-server");

       var randomID = "";
       var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
       var idLen = 20;
       for (var i = 0; i < idLen; i++) {
          randomID += chars.charAt(Math.random() * chars.length);
       }
       
       var client = new Paho.MQTT.Client("34.217.176.36", Number("9001"), randomID);

       // Connect to the MQTT broker as a client
       client.connect({onSuccess:onConnect});
       client.onConnectionLost = onConnectionLost;
       client.onMessageArrived = onMessageArrived;

       // Log when a connection is established, and subscribe to the appropriate topic
       function onConnect() {
	   console.log("onConnect");
	   client.subscribe("Stats");
       }

       function onFailure() {
	   console.log("Fail");
       }
       
       // Log errors when the connection is erroneously lost
       function onConnectionLost(responseObject) {
	   if (responseObject.errorCode !== 0) {
	       console.log("onConnectionLost:\n"+responseObject.errorMessage);
	   }
       }

       // Update statistics and the graphs once a message arrives
       function onMessageArrived(message) {
	    if (message.payloadString.length == 128) {
		   var aesCfb = new aesjs.ModeOfOperation.cfb(key, iv, 16);
		   console.log("onMessageArrived:\n"+message.payloadString);
		   var decryptedBytes = aesCfb.decrypt(message.payloadString);
		   console.log("DecryptedPayload:\n"+decryptedBytes);
		   var decryptedText = aesjs.utils.utf8.fromBytes(decryptedBytes);
		   console.log("DecryptedText:\n"+decryptedText+"\n");
	           // update_stats(message.payloadString);
		   update_stats(decryptedText);
		   update_graphs();
              } else {
		   console.log("Invalid cipher length: " + message.payloadString.length);
              }
       }
      </script>
   </body>
</html>
